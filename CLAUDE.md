# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

# Guild System - MANDATORY REQUIREMENTS

**CRITICAL DIRECTIVE**: Work ONLY with guidelines, framework, and scripts. 
**NEVER create or modify agents directly** - only update intelligence in guideline/ and templates.

## Mandatory Requirements

### From framework.md:
- **ALWAYS follow framework principles** read framework and recomendations first before making changes
- **ALWAYS apply intelligent understanding** through autonomous analysis
- **ALWAYS run verification** after implementation
- **ALWAYS iterate** until technical excellence achieved
- **FOLLOW** all Anthropic best practices from `guideline/guide/recommendations.md`

## Core Working Principles

### üéØ FOCUS AREAS (ONLY)
1. **Framework Intelligence** (`guideline/guide/framework.md`)
   - Update task execution logic
   - Enhance verification processes
   - Improve iteration patterns

2. **Core Modules** (`guideline/core/`)

3. **Command Templates** (`guideline/templates/`)
   - Templates define how commands work

4. **Installation Script** (`install.js`)
   - Generates commands from templates
   - Embeds core intelligence
   - Handles deployment

### ‚ùå NEVER TOUCH
- `.claude/agents/` directory - Generated by setup command
- `.claude/commands/` directory - Generated by setup command
- Individual agent files - Created by Guild system
- Agent prompts directly - Modified through templates only

## Working Protocol

### When Enhancing the System:
1. **Update Framework First** ‚Üí `guideline/guide/framework.md`
2. **Update Core Modules** ‚Üí `guideline/core/*.md`
3. **Update Templates** ‚Üí `guideline/templates/*.md`
4. **Regenerate Commands** ‚Üí Run `node install.js`

### Intelligence Flow:
```
framework.md (defines principles)
    ‚Üì
core/shared-intelligence.md (implements patterns)
    ‚Üì [loadIntelligenceModule()]
templates/workflow-command.md + templates/setup-command.md
    ‚Üì
install.js (processes in parallel)
    ‚îú‚îÄ‚Üí [generateAgentInventory()] ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îú‚îÄ‚Üí [generateSkillInventory()] ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
    ‚îî‚îÄ‚Üí [loadIntelligenceModule()] ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
                                         ‚Üì (results combined)
                                   [copyAndEmbedCommand()]
                                         ‚Üì
.claude/commands/guild/ (deployed commands with embedded intelligence)
    ‚Üì
.claude/skills/guild-patterns/ (awareness skill created)
    ‚Üì [createAwarenessSkill()]
User executes /guild or /guild:setup
```

### Architecture Details

**Intelligence Embedding Process:**
1. `loadIntelligenceModule()` - Loads shared intelligence from `guideline/core/shared-intelligence.md`
2. `generateAgentInventory()` - Scans target directory for existing agents to enable workflow coordination
3. `generateSkillInventory()` - Scans `.claude/skills/guild/` for SKILL.md files, parses YAML frontmatter metadata
4. `copyAndEmbedCommand()` - Takes templates, embeds intelligence, agent inventory, and skill inventory, generates final commands
5. `createAwarenessSkill()` - Creates awareness bridge skill from `guideline/templates/awareness-skill.md` template
6. Commands are deployed to `.claude/commands/guild/` with full intelligence embedded

**Template System:**
- `guideline/templates/workflow-command.md` ‚Üí `.claude/commands/guild/workflow.md`
- `guideline/templates/setup-command.md` ‚Üí `.claude/commands/guild/setup.md`
- Symlink created: `.claude/commands/guild.md` ‚Üí `guild/workflow.md`


## Development Workflow

### Intelligence-First Principle

**Core Philosophy**: Match process rigor to change complexity. Guild development follows an intelligent classification system that maintains quality while removing unnecessary overhead.

### Change Classification

Before making changes, identify the appropriate tier using the decision tree below:

#### Tier 1 - Trivial Changes (70% of changes)
**Examples**: Typos, formatting, link fixes, minor wording improvements

**Process**:
```bash
# 1. Make changes
vim guideline/guide/framework.md  # Fix typo

# 2. Validate
npm run validate:trivial

# 3. Commit
git commit -m "Fix typo in framework documentation"
```

**Required**: Structure validation only (`npm run validate:trivial`)
**Skip**: Requirements documentation, framework updates, intelligence updates, full testing
**Time**: ~5 seconds

---

#### Tier 2 - Content Updates (20% of changes)
**Examples**: Adding examples, clarifying documentation, updating anti-patterns, improving descriptions

**Process**:
```bash
# 1. Make changes
vim guideline/core/shared-intelligence.md  # Add example

# 2. Validate alignment
npm run validate:content

# 3. Optional: Test installation (recommended but not blocking)
npm run test-install

# 4. Commit
git commit -m "Add example for skill metadata structure"
```

**Required**: Alignment validation (`npm run validate:content`)
**Optional**: Framework documentation, installation test
**Skip**: Formal requirements, full 5-phase sequence
**Time**: ~30 seconds

---

#### Tier 3 - Pattern Changes (7% of changes)
**Examples**: New intelligence patterns, template behavior modifications, optimization updates

**Process**:
```bash
# 1. Update intelligence patterns
vim guideline/core/shared-intelligence.md

# 2. Update templates to use patterns
vim guideline/templates/workflow-command.md

# 3. Validate pattern alignment
npm run validate:patterns

# 4. Test installation
npm run test-install

# 5. Commit
git commit -m "Add MCP tool selection matrix pattern"
```

**Required**: Intelligence ‚Üí Template alignment, pattern tests, installation test
**Optional**: Formal requirements documentation
**Skip**: Full 5-phase sequential workflow
**Time**: ~2-3 minutes

---

#### Tier 4 - Architectural Changes (3% of changes)
**Examples**: Framework requirements, system capabilities, install.js modifications

**Process**: **FULL 5-PHASE WORKFLOW REQUIRED**

<requirements_driven_flow>
**Phase 1: Requirements Definition**
1. **Document Requirements** (`guideline/guide/framework.md`)
   - Define new capabilities or changes needed
   - Specify execution patterns and principles
   - Establish success criteria and constraints
   - ALWAYS align with `guideline/guide/recommendations.md`

2. **Update Framework Requirements** (`guideline/guide/framework.md`)
   - Modify core architecture principles
   - Update execution rules and patterns
   - Define new specialist coordination requirements
   - Ensure Lost in Middle mitigation compliance
   - Verify XML structure alignment with recommendations

**Phase 2: Command Requirements**
3. **Define Command-Specific Requirements**
   - **Workflow Command**: Task execution, delegation, verification patterns
   - **Setup Command**: Project analysis, specialist creation, discovery protocols
   - Document required capabilities and behaviors
   - Specify placeholder patterns and XML structure needs

**Phase 3: Intelligence Implementation**
4. **Update Shared Intelligence** (`guideline/core/shared-intelligence.md`)
   - Implement framework requirements as reusable patterns
   - Add new intelligence modules based on requirements
   - Create template embedding protocols
   - Include scratchpad management and document positioning guidelines
   - Ensure MCP tool selection matrices align with requirements

**Phase 4: Template Implementation**
5. **Update Command Templates** (`guideline/templates/`)
   - `workflow-command.md`: Implement task execution requirements
   - `setup-command.md`: Implement project analysis requirements
   - Apply Lost in Middle mitigation patterns
   - Integrate scratchpad management
   - Embed shared intelligence patterns

**Phase 5: Validation & Deployment**
6. **Validate Alignment** (`npm run validate && npm run test`)
   - Verify recommendations.md compliance
   - Confirm framework requirements implementation
   - Test intelligence embedding
   - Validate command generation

7. **Test Installation** (`node install.js`)
   - Test mode first: `node install.js --test-mode`
   - Install to test directory: `node install.js --no-interaction --path /tmp/test-guild`
   - Verify generated commands meet all requirements
</requirements_driven_flow>

**Required**: All 5 phases
**Skip**: Nothing - full rigor maintained
**Time**: ~5-10 minutes

---

### Decision Tree

```
Does it modify install.js? ‚Üí Tier 4
Does it change framework requirements or core principles? ‚Üí Tier 4
Does it add new system capabilities? ‚Üí Tier 4
Does it add NEW patterns to shared-intelligence.md? ‚Üí Tier 3
Does it change template behavior or structure? ‚Üí Tier 3
Does it update documentation, examples, or clarifications? ‚Üí Tier 2
Is it a typo, formatting, or link fix? ‚Üí Tier 1
```

**Quick Reference Table**:

| Files Changed | Typical Tier | Override if... |
|--------------|--------------|----------------|
| **install.js** | Tier 4 | Never - always architectural |
| **framework.md** (requirements/principles) | Tier 4 | Never - always architectural |
| **framework.md** (examples only) | Tier 2 | Adding new patterns ‚Üí Tier 3 |
| **shared-intelligence.md** (new patterns) | Tier 3 | Changing philosophy ‚Üí Tier 4 |
| **shared-intelligence.md** (examples/clarifications) | Tier 2 | Never - just content |
| **templates/*.md** (behavior changes) | Tier 3 | Just examples ‚Üí Tier 2 |
| **templates/*.md** (examples/wording) | Tier 2 | Structure changes ‚Üí Tier 3 |
| **CLAUDE.md, README.md** | Tier 2 | Never - documentation only |
| **tests/*.js** | Tier 3 | New test capability ‚Üí Tier 4 |

**When Uncertain**: Choose the higher tier (conservative approach)

### Mandatory Alignment Protocol

<alignment_requirements>
**EVERYTHING MUST ALIGN WITH**:
1. **`guideline/guide/recommendations.md`** - Opus 4.1 optimization patterns
2. **`guideline/guide/framework.md`** - Core architecture principles
3. **Requirements Definition** - Documented capabilities and constraints (Tier 4 only)

**TIER-SPECIFIC RULES**:

**Tier 1 & 2**: Lightweight validation, alignment checks automated
**Tier 3**: Intelligence-template alignment mandatory, installation test required
**Tier 4**: Full 5-phase workflow, all alignment checks mandatory

**NEVER**:
- Skip validation for your tier
- Deploy Tier 3+ changes without testing installation
- Update templates without updating shared intelligence (Tier 3+)
- Modify framework requirements without full Tier 4 workflow

**ALWAYS**:
- Run the appropriate validation command for your tier
- Validate alignment through automated checks
- Test installation for Tier 3+ changes
- Document architectural changes in framework.md (Tier 4)
</alignment_requirements>

### Tier-Based Testing Protocol

**Validation commands match change complexity**:

#### Tier 1: Trivial Validation
```bash
npm run validate:trivial
# Runs: Structure validation only
# Time: ~5 seconds
```

#### Tier 2: Content Validation
```bash
npm run validate:content
# Runs: Structure + alignment checks
# Time: ~30 seconds
```

#### Tier 3: Pattern Validation
```bash
npm run validate:patterns
# Runs: Alignment + pattern tests + installation test
# Time: ~2-3 minutes
```

#### Tier 4: Architectural Validation
```bash
npm run validate:architectural
# Runs: Full test suite (same as `npm run test`)
# Includes all phases from the 5-phase workflow
# Time: ~5-10 minutes
```

#### Auto-Detect Validation
```bash
npm run validate:auto
# Automatically detects tier from changed files
# Runs appropriate validation
# Useful for pre-commit hooks
```

<phase_testing>
**Tier 4 Only - Full Phase Testing**

**Phase 1: Requirements Validation**
```bash
# Verify framework requirements are documented
grep -n "requirement\|MANDATORY\|CRITICAL" guideline/guide/framework.md

# Confirm recommendations.md alignment
npm run validate-guidelines
```

**Phase 2: Framework Testing**
```bash
# Validate framework structure
npm run validate-structure

# Test framework consistency
grep -n "<critical>\|Lost in Middle\|scratchpad" guideline/guide/framework.md
```

**Phase 3: Intelligence Testing**
```bash
# Test shared intelligence loading
node install.js --test-mode

# Verify intelligence patterns
grep -n "Research Protocol\|MCP Tool Selection\|Document Positioning" guideline/core/shared-intelligence.md
```

**Phase 4: Template Testing**
```bash
# Validate template structure
npm run validate

# Test template generation
node install.js --no-interaction --path /tmp/test-requirements

# Verify alignment implementation
grep -n "CRITICAL.*READ FIRST|scratchpad\|instruction>" /tmp/test-requirements/.claude/commands/guild/workflow.md
```

**Phase 5: Complete Integration Testing**
```bash
# Full validation suite
npm run test

# Clean installation test
rm -rf /tmp/test-requirements-complete
node install.js --no-interaction --path /tmp/test-requirements-complete

# Verify ALL requirements implemented
cat /tmp/test-requirements-complete/.claude/commands/guild/workflow.md | grep -E "(CRITICAL|scratchpad|research|Lost in Middle)"
```
</phase_testing>

## Requirements-First Intelligence Protocol

**CRITICAL: Requirements drive intelligence, framework enforces implementation, recommendations ensure optimization**

<intelligence_update_flow>
**Step 1: Requirements Analysis & Framework Update**
- **Document Requirements** in `guideline/guide/framework.md`
  - Define new capabilities needed
  - Specify architectural changes required
  - Document execution pattern modifications
  - Establish success criteria and constraints

- **Update Framework Architecture** (`guideline/guide/framework.md`)
  - Implement requirements as core principles
  - Update execution rules and specialist protocols
  - Define new dynamic agent creation patterns
  - Ensure recommendations.md alignment

**Step 2: Command Requirements Definition**
- **Workflow Command Requirements**: Task execution, delegation, research protocols
- **Setup Command Requirements**: Project analysis, specialist creation, discovery patterns
- **Shared Requirements**: Parallel execution, gap detection, verification frameworks

**Step 3: Shared Intelligence Implementation**
- **Requirements Translation** (`guideline/core/shared-intelligence.md`)
  - Convert framework requirements to reusable patterns
  - Implement MCP tool selection matrices
  - Create research and reasoning protocols
  - Add document positioning guidelines
  - Define scratchpad management standards

**Step 4: Template Implementation**
- **Template Updates** (`guideline/templates/`)
  - `workflow-command.md`: Implement execution requirements with Lost in Middle mitigation
  - `setup-command.md`: Implement analysis requirements with proper XML structure
  - Apply all shared intelligence patterns
  - Integrate scratchpad management

**Step 5: Installation Logic Updates**
- **Script Updates** (`install.js`) - Only if requirements demand it
  - Modify intelligence embedding process
  - Update command generation logic
  - Change deployment structure if needed
</intelligence_update_flow>

### Requirements Compliance Matrix

<compliance_validation>
**EVERY UPDATE MUST VERIFY**:
1. ‚úÖ **Framework Requirements**: All documented requirements implemented
2. ‚úÖ **Recommendations Alignment**: Lost in Middle, XML structure, scratchpad management
3. ‚úÖ **Intelligence Consistency**: Shared patterns properly embedded in templates
4. ‚úÖ **Template Compliance**: Commands implement all framework and shared intelligence
5. ‚úÖ **Installation Verification**: Generated commands contain all required patterns

**VALIDATION COMMANDS**:
```bash
# Requirements implemented
grep -c "requirement\|MANDATORY\|CRITICAL" guideline/guide/framework.md

# Recommendations applied  
grep -c "Lost in Middle\|scratchpad\|critical>" guideline/templates/*.md

# Intelligence embedded
grep -c "Research Protocol\|MCP Tool\|Document Positioning" guideline/core/shared-intelligence.md

# Templates aligned
npm run validate && node install.js --test-mode
```
</compliance_validation>

## Testing and Validation Protocols

### Requirements-First Development Principles

<development_principles>
**MANDATORY PRINCIPLES**:
1. **Requirements Drive Everything**: Never implement without documented requirements in framework.md
2. **Framework Authority**: framework.md is the single source of truth for all patterns
3. **Recommendations Compliance**: Every change MUST align with guideline/guide/recommendations.md
4. **Sequential Implementation**: Requirements ‚Üí Framework ‚Üí Command Requirements ‚Üí Intelligence ‚Üí Templates ‚Üí Validation
5. **No Skip Steps**: Cannot update templates without updating shared intelligence first
6. **Validation at Each Phase**: Test alignment before proceeding to next phase

**ANTI-PATTERNS TO AVOID**:
‚ùå **Template-First Development**: Never start by updating templates
‚ùå **Framework Bypass**: Never skip framework updates when adding capabilities
‚ùå **Recommendations Ignorance**: Never ignore Lost in Middle, scratchpad, or XML structure patterns
‚ùå **Intelligence Bypass**: Never update templates without updating shared intelligence
‚ùå **Validation Skipping**: Never deploy without testing requirements implementation
‚ùå **Partial Implementation**: Never leave requirements partially implemented across files
</development_principles>

### Pre-Development Validation
**Before making changes - IDENTIFY YOUR TIER**:
```bash
# 1. Classify your change using the decision tree
# 2. Ensure clean starting state
npm run validate

# 3. For Tier 4 only: Document requirements in framework.md FIRST
# For other tiers: Proceed with changes
```

### Requirements-Based Development Testing
**During development - VALIDATE EACH PHASE**:

<phase_validation>
**After Requirements Definition**:
```bash
# Verify requirements documented in framework
grep -n "requirement\|capability\|pattern" guideline/guide/framework.md

# Check recommendations alignment
grep -n "Lost in Middle\|scratchpad\|XML" guideline/guide/recommendations.md
```

**After Framework Updates**:
```bash
# Validate framework structure and consistency
npm run validate-structure

# Test framework requirement implementation
grep -c "MANDATORY\|CRITICAL\|requirement" guideline/guide/framework.md
```

**After Command Requirements Definition**:
```bash
# Document what each command must implement
echo "Verify workflow and setup command requirements documented"

# Check requirement traceability
grep -n "workflow.*requirement\|setup.*requirement" guideline/guide/framework.md
```

**After Shared Intelligence Updates**:
```bash
# Test intelligence loading and embedding
node install.js --test-mode

# Verify intelligence implements framework requirements
grep -c "Research Protocol\|MCP Tool\|Document Positioning" guideline/core/shared-intelligence.md
```

**After Template Updates**:
```bash
# Validate template structure and alignment
npm run validate-guidelines

# Test template implements shared intelligence
grep -c "research\|scratchpad\|critical" guideline/templates/*.md

# Quick installation test
node install.js --no-interaction --path /tmp/test-dev-phase
```
</phase_validation>

### Pre-Commit Validation
**Before committing changes:**
```bash
# Full validation suite
npm run test

# Test installation to isolated directory
rm -rf /tmp/test-guild-validation
node install.js --no-interaction --path /tmp/test-guild-validation

# Verify generated commands contain expected intelligence
grep -q "thinking_mode: ultrathink" /tmp/test-guild-validation/.claude/commands/guild/*.md && echo "‚úÖ Intelligence embedded" || echo "‚ùå Missing intelligence"

# Clean up test directory
rm -rf /tmp/test-guild-validation
```

### Integration Testing
**Test with actual Claude Code usage:**
```bash
# Install to test project
mkdir -p /tmp/guild-integration-test
cd /tmp/guild-integration-test
node /path/to/claude-guild/install.js --no-interaction --path .

# Verify commands are accessible
ls -la .claude/commands/guild/
cat .claude/commands/guild.md  # Should be symlink to workflow
```

## Publishing Workflow

### Pre-Publishing Checklist
1. **Validate all systems:** `npm run test`
2. **Update version:** `npm version [patch|minor|major]`
3. **Test installation:** Clean test in isolated environment
4. **Review generated commands:** Ensure intelligence embedding works correctly

### Publishing Process
```bash
# Automated publishing (recommended)
npm run publish

# Or non-interactive publishing
npm run publish-non-interactive

# Or direct npm publish (bypasses validation - use with caution)
npm run publish-direct
```

### Post-Publishing Verification
```bash
# Test installation from npm
npx claude-guild@latest --version

# Test in clean environment
mkdir -p /tmp/npm-test
cd /tmp/npm-test
npx claude-guild@latest
# Should successfully install Guild commands
```

## Summary

**YOU WORK WITH**:
- ‚úÖ Guidelines and frameworks
- ‚úÖ Templates and patterns
- ‚úÖ Installation scripts
- ‚úÖ Core intelligence modules

**YOU DON'T WORK WITH**:
- ‚ùå Individual agent files
- ‚ùå Agent directories
- ‚ùå Direct agent creation
- ‚ùå Agent modification

The Guild system generates agents from templates. Your role is to enhance the intelligence that drives that generation, not to create agents directly.

## Development Commands

### Tier-Based Validation Commands (NEW)
- `npm run validate:trivial` - Tier 1: Structure validation only (~5 sec)
- `npm run validate:content` - Tier 2: Structure + alignment checks (~30 sec)
- `npm run validate:patterns` - Tier 3: Alignment + patterns + install test (~2-3 min)
- `npm run validate:architectural` - Tier 4: Full test suite (~5-10 min)
- `npm run validate:auto` - Auto-detect tier and validate

### Core Commands
- `npm run validate` - Validate guidelines and project structure
- `npm run test` - Run all validation and test installation (same as validate:architectural)
- `npm run test-install` - Quick validation without full installation
- `node install.js` - Install Guild commands to home directory (interactive)
- `node install.js --no-interaction --path <dir>` - Install to specific directory
- `node install.js --test-mode` - Quick validation without installation

### Publishing Commands
- `npm run publish` - Interactive publish to npm registry with validation
- `npm run publish-non-interactive` - Automated publish without prompts
- `npm run publish-direct` - Direct npm publish (bypass validation)
- `npm version [patch|minor|major]` - Update package version

### Legacy Validation Commands
- `npm run validate-guidelines` - Check guideline structure
- `npm run validate-structure` - Verify required project files